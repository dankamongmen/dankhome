#!/bin/sh

set -e
set -o nounset

usage () { echo "usage: $0" ; }
usageerr () { usage >&2 ; return 1 ; }

[ $# -eq 0 ] || usageerr

HOMESERV=recombinator.orthanc
if ! host $HOMESERV ; then
	HOMESERV=recombinator
fi

PATH=$PATH:/usr/sbin:/sbin

case `hostname` in
	recombinator)
		dbus-daemon --session --fork
		#daemonizer -p $TMPDIR/daemonizer.pop.pid -r 0 -- ssh -N -L 11110:localhost:110 qemfd.net &
		daemonizer -p $TMPDIR/daemonizer.smtp.pid -r 0 -- ssh -N -L 11111:localhost:25 qemfd.net &
		! which fetchmail 2> /dev/null || fetchmail
		#commitpidgin
		if ! sudo aptitude -s -V -v -Z update ; then
			echo "aptitude returned $?" >&2
		fi
		#cd tmp/torrenting && screen nice rtorrent
		cd
		;;

	kingfriday)
		avant-window-navigator -startup &
		nautilus --no-default-window
		ssh-add -l || ssh-add
		gnome-screensaver
		notify-send "Done initializing kingfriday..."
		# experimental -- otherwise start hangs around :/
		exit
		;;	

	eschatomatic)
		avant-window-navigator -startup &
		nautilus --no-default-window
		ssh-add -l || ssh-add
		wpa_gui -i wlan0 -t &
		;;

	hyperbox)
		avant-window-navigator -startup &
		ssh-add -l || ssh-add
		wpa_gui -i wlan0 -t &
		notify-send -i /usr/share/app-install/icons/ssh-askpass-gnome.png "Setting up SSH tunnels..."
		# don't exit on failures here
		#if ! ssh -f -L 11110:localhost:110 $HOMESERV -N ; then
		#	notify-send -i /usr/share/app-install/icons/ssh-askpass-gnome "Couldn't set up POP SSH tunnel..."
		#fi
		if ! ssh -f -L 6600:localhost:6600 $HOMESERV -N ; then
			notify-send -i /usr/share/app-install/icons/ssh-askpass-gnome "Couldn't set up MPD SSH tunnel..."
		else
			gmpc --start-hidden &
		fi
		notify-send -i /usr/share/icons/gnome-alternative/scalable/places/gnome-fs-ssh.svg "Setting up SSHfs..."
		if ! sshfs -o noatime -o reconnect $HOMESERV:/media /media/sshfs -oCiphers=arcfour ; then
			echo "Couldn't set up SSHfs..."
		fi
		if ! sshfs -o noatime -o reconnect $HOMESERV:/home/dank /media/sshfshome -oCiphers=arcfour ; then
			echo "Couldn't set up SSHfs..."
		fi
		notify-send -i /usr/share/app-install/icons/pidgin.png "Syncing pidgin..."
		#rsync --progress --stats -ziau .purple $HOMESERV:.purple || true
		rsync --progress --stats -ziau $HOMESERV:.purple . || true
		notify-send -i /usr/share/app-install/icons/filelight.png "Syncing files..."
		#rsync --progress --stats -ziau files $HOMESERV:files || true
		rsync --progress --stats -ziau $HOMESERV:files . || true
		#sudo aptitude update
		mail-notification &
		gnome-screensaver
		notify-send "Done initializing hyperbox..."
		pidgin &
		;;

	areopagod)
		sudo openvt -u
		ssh-add $HOME/.ssh/qemu.rsa $HOME/.ssh/swps.rsa
		svn revert -R .purple
		commitpidgin
		sudo aptitude update
		svn up ~/files
		cd src/libtorque && git pull && cd -
		cd src/libdank && git pull && cd -
		;;
	*)
		echo "No support for hostname `hostname`" >&2
		exit 1
		;;
esac
