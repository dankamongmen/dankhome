#!/bin/sh

set -e
set -o nounset

usage () { echo "usage: $0" ; }
usageerr () { usage >&2 ; return 1 ; }

[ $# -eq 0 ] || usageerr

HOMESERV=recombinator.orthanc
if ! host $HOMESERV 2>&1 > /dev/null ; then
	HOMESERV=recombinator
fi

PATH=$PATH:/usr/sbin:/sbin

case `hostname` in
	skynet)
		# start dbus FIXME
		;;
	recombinator)
		#dbus-daemon --session --fork
		! which fetchmail 2> /dev/null || fetchmail
		postqueue -f
		#commitpidgin
		if ! sudo aptitude -s -V -v -Z update ; then
			echo "aptitude returned $?" >&2
		fi
		cd
		;;

	kingfriday)
		notify-send "Done initializing kingfriday..."
		;;	

	eschatomatic)
		for i in ghettostore ghettospare quadtera ; do
			if ! mount | grep ^/media/$i ; then
				sudo mount -t nfs skynet.orthanc:/media/$i -o ro,guest /mnt/$i
			fi
		done
		notify-send "Done initializing eschatomatic..."
		;;

	hyperbox)
		avant-window-navigator -startup &
		ssh-add -l || ssh-add
		#wpa_gui -i wlan0 -t &
		notify-send -i /usr/share/app-install/icons/ssh-askpass-gnome.png "Setting up SSH tunnels..."
		# don't exit on failures here
		#if ! ssh -f -L 11110:localhost:110 $HOMESERV -N ; then
		#	notify-send -i /usr/share/app-install/icons/ssh-askpass-gnome "Couldn't set up POP SSH tunnel..."
		#fi
		if ! ssh -f -L 6600:localhost:6600 $HOMESERV -N ; then
			notify-send -i /usr/share/app-install/icons/ssh-askpass-gnome "Couldn't set up MPD SSH tunnel..."
		else
			gmpc --start-hidden &
		fi
		notify-send -i /usr/share/icons/gnome-alternative/scalable/places/gnome-fs-ssh.svg "Setting up SSHfs..."
		if ! sshfs -o noatime -o reconnect $HOMESERV:/media /media/sshfs -oCiphers=arcfour ; then
			echo "Couldn't set up SSHfs..."
		fi
		if ! sshfs -o noatime -o reconnect $HOMESERV:/home/dank /media/sshfshome -oCiphers=arcfour ; then
			echo "Couldn't set up SSHfs..."
		fi
		notify-send -i /usr/share/app-install/icons/pidgin.png "Syncing pidgin..."
		#rsync --progress --stats -ziau .purple $HOMESERV:.purple || true
		rsync --progress --stats -ziau $HOMESERV:.purple . || true
		notify-send -i /usr/share/app-install/icons/filelight.png "Syncing files..."
		#rsync --progress --stats -ziau files $HOMESERV:files || true
		rsync --progress --stats -ziau $HOMESERV:files . || true
		#sudo aptitude update
		mail-notification &
		gnome-screensaver
		notify-send "Done initializing hyperbox..."
		pidgin &
		;;

	areopagod)
		sudo openvt -u
		ssh-add $HOME/.ssh/qemu.rsa $HOME/.ssh/swps.rsa
		svn revert -R .purple
		commitpidgin
		sudo aptitude update
		svn up ~/files
		cd src/libtorque && git pull && cd -
		cd src/libdank && git pull && cd -
		;;
	*)
		echo "No support for hostname `hostname`" >&2
		exit 1
		;;
esac
